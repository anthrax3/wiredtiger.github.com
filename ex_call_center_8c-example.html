<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: ex_call_center.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="wiredtiger.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->

<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo">
    <div class="logo"><a href="http://wiredtiger.com/"><img src="images/LogoFinal-header.png" alt="WiredTiger" /></a></div>
  </td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 0.10.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ex_call_center_8c-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ex_call_center.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>A more complex schema based on a call center example, showing how to map some SQL constructs onto the WiredTiger API.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*-</span>
<span class="comment"> * Copyright (c) 2008-2012 WiredTiger, Inc.</span>
<span class="comment"> *</span>
<span class="comment"> * This is free and unencumbered software released into the public domain.</span>
<span class="comment"> *</span>
<span class="comment"> * Anyone is free to copy, modify, publish, use, compile, sell, or</span>
<span class="comment"> * distribute this software, either in source code form or as a compiled</span>
<span class="comment"> * binary, for any purpose, commercial or non-commercial, and by any</span>
<span class="comment"> * means.</span>
<span class="comment"> *</span>
<span class="comment"> * In jurisdictions that recognize copyright laws, the author or authors</span>
<span class="comment"> * of this software dedicate any and all copyright interest in the</span>
<span class="comment"> * software to the public domain. We make this dedication for the benefit</span>
<span class="comment"> * of the public at large and to the detriment of our heirs and</span>
<span class="comment"> * successors. We intend this dedication to be an overt act of</span>
<span class="comment"> * relinquishment in perpetuity of all present and future rights to this</span>
<span class="comment"> * software under copyright law.</span>
<span class="comment"> *</span>
<span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="comment"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="comment"> * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="comment"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="comment"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="comment"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="comment"> *</span>
<span class="comment"> * ex_call_center.c</span>
<span class="comment"> *      This is an example application that demonstrates how to map a</span>
<span class="comment"> *      moderately complex SQL application into WiredTiger.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;inttypes.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>

<span class="preprocessor">#include &lt;wiredtiger.h&gt;</span>

<span class="keyword">const</span> <span class="keywordtype">char</span> *home = <span class="stringliteral">&quot;WT_TEST&quot;</span>;

<span class="comment">/*</span>
<span class="comment"> * In SQL, the tables are described as follows:</span>
<span class="comment"> *</span>
<span class="comment"> * CREATE TABLE Customers(id INTEGER PRIMARY KEY,</span>
<span class="comment"> *     name VARCHAR(30), address VARCHAR(50), phone VARCHAR(15))</span>
<span class="comment"> * CREATE INDEX CustomersPhone ON Customers(phone)</span>
<span class="comment"> *</span>
<span class="comment"> * CREATE TABLE Calls(id INTEGER PRIMARY KEY, call_date DATE,</span>
<span class="comment"> *     cust_id INTEGER, emp_id INTEGER, call_type VARCHAR(12),</span>
<span class="comment"> *     notes VARCHAR(25))</span>
<span class="comment"> * CREATE INDEX CallsCustDate ON Calls(cust_id, call_date)</span>
<span class="comment"> *</span>
<span class="comment"> * In this example, both tables will use record numbers for their IDs, which</span>
<span class="comment"> * will be the key.  The C structs for the records are as follows.</span>
<span class="comment"> */</span>

<span class="comment">/* Customer records. */</span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>{
        uint64_t id;
        <span class="keywordtype">char</span> *name;
        <span class="keywordtype">char</span> *address;
        <span class="keywordtype">char</span> *phone;
} CUSTOMER;

<span class="comment">/* Call records. */</span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>{
        uint64_t id;
        uint64_t call_date;
        uint64_t cust_id;
        uint64_t emp_id;
        <span class="keywordtype">char</span> *call_type;
        <span class="keywordtype">char</span> *notes;
} CALL;
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
        <span class="keywordtype">int</span> count, exact, ret;
        <a name="_a0"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html" title="A connection to a WiredTiger database.">WT_CONNECTION</a> *conn;
        <a name="_a1"></a><a class="code" href="struct_w_t___s_e_s_s_i_o_n.html" title="All data operations are performed in the context of a WT_SESSION.">WT_SESSION</a> *session;
        <a name="_a2"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html" title="A WT_CURSOR handle is the interface to a cursor.">WT_CURSOR</a> *cursor;
        CUSTOMER cust;
        CALL call;

        ret = <a name="a3"></a><a class="code" href="group__wt.html#ga9e6adae3fc6964ef837a62795c7840ed" title="Open a connection to a database.">wiredtiger_open</a>(home, NULL, <span class="stringliteral">&quot;create&quot;</span>, &amp;conn);
        <span class="keywordflow">if</span> (ret != 0) {
                fprintf(stderr, <span class="stringliteral">&quot;Error connecting to %s: %s\n&quot;</span>,
                    home, <a name="a4"></a><a class="code" href="group__wt.html#gac95e70a24d09cf6928398512990e1474" title="Return information about an error as a string; wiredtiger_strerror is a superset of the ISO C99/POSIX...">wiredtiger_strerror</a>(ret));
                <span class="keywordflow">return</span> (1);
        }
        <span class="comment">/* Note: further error checking omitted for clarity. */</span>

        ret = conn-&gt;<a name="a5"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#afc75c44ff4497627c59d9b6aaa64c9d8" title="Open a session.">open_session</a>(conn, NULL, NULL, &amp;session);

        <span class="comment">/*</span>
<span class="comment">         * Create the customers table, give names and types to the columns.</span>
<span class="comment">         * The columns will be stored in two groups: &quot;main&quot; and &quot;address&quot;,</span>
<span class="comment">         * created below.</span>
<span class="comment">         */</span>
        ret = session-&gt;<a name="a6"></a><a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session, <span class="stringliteral">&quot;table:customers&quot;</span>,
            <span class="stringliteral">&quot;key_format=S,&quot;</span>
            <span class="stringliteral">&quot;value_format=SSS,&quot;</span>
            <span class="stringliteral">&quot;columns=(id,name,address,phone),&quot;</span>
            <span class="stringliteral">&quot;colgroups=(main,address)&quot;</span>);

        <span class="comment">/* Create the main column group with value columns except address. */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session,
            <span class="stringliteral">&quot;colgroup:customers:main&quot;</span>, <span class="stringliteral">&quot;columns=(name,phone)&quot;</span>);

        <span class="comment">/* Create the address column group with just the address. */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session,
            <span class="stringliteral">&quot;colgroup:customers:address&quot;</span>, <span class="stringliteral">&quot;columns=(address)&quot;</span>);

        <span class="comment">/* Create an index on the customer table by phone number. */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session,
            <span class="stringliteral">&quot;index:customers:phone&quot;</span>, <span class="stringliteral">&quot;columns=(phone)&quot;</span>);

        <span class="comment">/*</span>
<span class="comment">         * Create the calls table, give names and types to the columns.</span>
<span class="comment">         * All of the columns will be stored together, so no column groups are</span>
<span class="comment">         * declared.</span>
<span class="comment">         */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session, <span class="stringliteral">&quot;table:calls&quot;</span>,
            <span class="stringliteral">&quot;key_format=r,&quot;</span>
            <span class="stringliteral">&quot;value_format=qrrSS,&quot;</span>
            <span class="stringliteral">&quot;columns=(id,call_date,cust_id,emp_id,call_type,notes)&quot;</span>);

        <span class="comment">/*</span>
<span class="comment">         * Create an index on the calls table with a composite key of cust_id</span>
<span class="comment">         * and call_date.</span>
<span class="comment">         */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">create</a>(session, <span class="stringliteral">&quot;index:calls:cust_date&quot;</span>,
            <span class="stringliteral">&quot;columns=(cust_id,call_date)&quot;</span>);

        <span class="comment">/* Populate the customers table with some data. */</span>
        ret = session-&gt;<a name="a7"></a><a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d" title="Open a cursor.">open_cursor</a>(
            session, <span class="stringliteral">&quot;table:customers&quot;</span>, NULL, NULL, &amp;cursor);

        cursor-&gt;<a name="a8"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#ad1088d719df40babc1f57d086691ebdc" title="Set the key for the next operation.">set_key</a>(cursor, <span class="stringliteral">&quot;customer #1&quot;</span>);
        cursor-&gt;<a name="a9"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#a27f7cbd0cd3e561f6a145704813ad64c" title="Set the value for the next operation.">set_value</a>(cursor,
            <span class="stringliteral">&quot;Professor Oak&quot;</span>, <span class="stringliteral">&quot;LeafGreen Avenue&quot;</span>, <span class="stringliteral">&quot;123-456-7890&quot;</span>);
        ret = cursor-&gt;<a name="a10"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#aac90d9fbcc031570f924db55f8a1cee3" title="Insert a record, and optionally overwrite an existing record.">insert</a>(cursor);

        cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#ad1088d719df40babc1f57d086691ebdc" title="Set the key for the next operation.">set_key</a>(cursor, <span class="stringliteral">&quot;customer #2&quot;</span>);
        cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#a27f7cbd0cd3e561f6a145704813ad64c" title="Set the value for the next operation.">set_value</a>(cursor, <span class="stringliteral">&quot;Lorelei&quot;</span>, <span class="stringliteral">&quot;Sevii Islands&quot;</span>, <span class="stringliteral">&quot;098-765-4321&quot;</span>);
        ret = cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#aac90d9fbcc031570f924db55f8a1cee3" title="Insert a record, and optionally overwrite an existing record.">insert</a>(cursor);

        ret = cursor-&gt;<a name="a11"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#ae5e6412ab3d895d68f454e59963fd391" title="Close the cursor.">close</a>(cursor, NULL);

        <span class="comment">/*</span>
<span class="comment">         * First query: a call arrives.  In SQL:</span>
<span class="comment">         *</span>
<span class="comment">         * SELECT id, name FROM Customers WHERE phone=?</span>
<span class="comment">         *</span>
<span class="comment">         * Use the cust_phone index, lookup by phone number to fill the</span>
<span class="comment">         * customer record.  The cursor will have a key format of &quot;S&quot; for a</span>
<span class="comment">         * string because the cust_phone index has a single column (&quot;phone&quot;),</span>
<span class="comment">         * which is of type &quot;S&quot;.</span>
<span class="comment">         *</span>
<span class="comment">         * Specify the columns we want: the customer ID and the name.  This</span>
<span class="comment">         * means the cursor&#39;s value format will be &quot;rS&quot;.</span>
<span class="comment">         */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d" title="Open a cursor.">open_cursor</a>(session,
            <span class="stringliteral">&quot;index:customers:phone(id,name)&quot;</span>,
            NULL, NULL, &amp;cursor);
        cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#ad1088d719df40babc1f57d086691ebdc" title="Set the key for the next operation.">set_key</a>(cursor, <span class="stringliteral">&quot;212-555-1000&quot;</span>);
        ret = cursor-&gt;<a name="a12"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#a7e25b2ced2cf3ec68bd5429bf921c79f" title="Move to the record matching the key.">search</a>(cursor);
        <span class="keywordflow">if</span> (ret == 0) {
                ret = cursor-&gt;<a name="a13"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#af85364a5af50b95bbc46c82e72f75c01" title="Get the value for the current record.">get_value</a>(cursor, &amp;cust.id, &amp;cust.name);
                printf(<span class="stringliteral">&quot;Got customer record for %s\n&quot;</span>, cust.name);
        }
        ret = cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#ae5e6412ab3d895d68f454e59963fd391" title="Close the cursor.">close</a>(cursor, NULL);

        <span class="comment">/*</span>
<span class="comment">         * Next query: get the recent order history.  In SQL:</span>
<span class="comment">         *</span>
<span class="comment">         * SELECT * FROM Calls WHERE cust_id=? ORDER BY call_date DESC LIMIT 3</span>
<span class="comment">         *</span>
<span class="comment">         * Use the call_cust_date index to find the matching calls.  Since it is</span>
<span class="comment">         * is in increasing order by date for a given customer, we want to start</span>
<span class="comment">         * with the last record for the customer and work backwards.</span>
<span class="comment">         *</span>
<span class="comment">         * Specify a subset of columns to be returned.  If these were all</span>
<span class="comment">         * covered by the index, the primary would not be accessed.  Stop after</span>
<span class="comment">         * getting 3 records.</span>
<span class="comment">         */</span>
        ret = session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d" title="Open a cursor.">open_cursor</a>(session,
            <span class="stringliteral">&quot;index:calls:cust_date(cust_id,call_type,notes)&quot;</span>,
            NULL, NULL, &amp;cursor);

        <span class="comment">/*</span>
<span class="comment">         * The keys in the index are (cust_id,call_date) -- we want the largest</span>
<span class="comment">         * call date for a given cust_id.  Search for (cust_id+1,0), then work</span>
<span class="comment">         * backwards.</span>
<span class="comment">         */</span>
        cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#ad1088d719df40babc1f57d086691ebdc" title="Set the key for the next operation.">set_key</a>(cursor, cust.id + 1, 0);
        ret = cursor-&gt;<a name="a14"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#a8068ddce20d0775f26f6dac6e5eb209c" title="Move to the record matching the key if it exists, or a record that would be adjacent.">search_near</a>(cursor, &amp;exact);

        <span class="comment">/*</span>
<span class="comment">         * If the table is empty, search_near will return WT_NOTFOUND.</span>
<span class="comment">         * Otherwise the cursor will on a matching key if one exists, or on an</span>
<span class="comment">         * adjacent key.  If the key we find is equal or larger than the search</span>
<span class="comment">         * key, go back one.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (ret == 0 &amp;&amp; exact &gt;= 0)
                ret = cursor-&gt;<a name="a15"></a><a class="code" href="struct_w_t___c_u_r_s_o_r.html#a43d6664d2f68902aa63f933864242e76" title="Return the previous record.">prev</a>(cursor);
        <span class="keywordflow">if</span> (ret == 0)
                ret = cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#af85364a5af50b95bbc46c82e72f75c01" title="Get the value for the current record.">get_value</a>(cursor,
                    &amp;call.cust_id, &amp;call.call_type, &amp;call.notes);

        count = 0;
        <span class="keywordflow">while</span> (ret == 0 &amp;&amp; call.cust_id == cust.id) {
                printf(<span class="stringliteral">&quot;Got call record on date %lu: type %s: %s\n&quot;</span>,
                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)call.call_date, call.call_type, call.notes);
                <span class="keywordflow">if</span> (++count == 3)
                        <span class="keywordflow">break</span>;

                ret = cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#a43d6664d2f68902aa63f933864242e76" title="Return the previous record.">prev</a>(cursor);
                ret = cursor-&gt;<a class="code" href="struct_w_t___c_u_r_s_o_r.html#af85364a5af50b95bbc46c82e72f75c01" title="Get the value for the current record.">get_value</a>(cursor,
                    &amp;call.cust_id, &amp;call.call_type, &amp;call.notes);
        }
        ret = conn-&gt;<a name="a16"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#af535c517df851eeac8ebf3594d40b545" title="Close a connection.">close</a>(conn, NULL);

        <span class="keywordflow">return</span> (ret);
}
</pre></div> </div><!-- contents -->
</div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>

    <li class="footer">Copyright (c) 2008-2011 WiredTiger.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
   </ul>
 </div>


</body>
</html>
